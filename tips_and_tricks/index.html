<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://www.data-mining.co.nz/docker-for-data-scientists/tips_and_tricks/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Tips & Tricks - Docker for Data Scientists</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Tips \u0026 Tricks";
        var mkdocs_page_input_path = "tips_and_tricks.md";
        var mkdocs_page_url = "/docker-for-data-scientists/tips_and_tricks/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Docker for Data Scientists
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../basics/">Basics</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../repos/">Repositories</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../dockerfile/">Dockerfile</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../best_practices/">Best practices</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Tips & Tricks</a>
    <ul class="current">
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../automation/">Automation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../registry/">Registry</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Docker for Data Scientists</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Tips & Tricks</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h3 id="remove-unwanted-files">Remove unwanted files</h3>
<p>Especially during development, it can happen that files get generated when running
your docker container that can only be removed by the <code>root</code> user again. If you 
do not have admin permissions (e.g., via <code>sudo</code>) on the machine then you can 
revert to using docker to remove them again:</p>
<ul>
<li>
<p>change into the directory with unwanted files and/or directories</p>
</li>
<li>
<p>the following docker command will map the current directory to <code>/opt/local</code>:</p>
<p><code>docker run -v `pwd`:/opt/local -it bash:5.1.8</code></p>
</li>
<li>
<p>change into <code>/opt/local</code> and remove all files/dirs (or just the files that need removing):</p>
<p><code>cd /opt/local
rm -Rf *</code></p>
</li>
</ul>
<h3 id="python">Python</h3>
<h4 id="alternative-python-version">Alternative Python version</h4>
<p>In case your base Debian/Ubuntu distribution does not have the right Python version 
available, you can get additional versions by adding the <a href="https://launchpad.net/~deadsnakes/+archive/ubuntu/ppa">deadsnakes ppa</a>:</p>
<pre><code class="language-bash">add-apt-repository -y ppa:deadsnakes/ppa &amp;&amp; \
apt-get update
</code></pre>
<h4 id="switch-default-python-version">Switch default Python version</h4>
<p>If your base distro has an older version of Python and you do not want to sprinkle the
specific newer version throughout your <code>Dockerfile</code>, then you can use <code>update-alternatives</code>
on Debian systems to change the default.</p>
<p>The following commands switch from Python 3.5 to Python 3.6 for the <code>python3</code> executable
and also use Python 3.6 as the default for the <code>python</code> executable:</p>
<pre><code class="language-commandline">update-alternatives --install /usr/bin/python python /usr/bin/python3.5 1 &amp;&amp; \
update-alternatives --install /usr/bin/python python /usr/bin/python3.6 2 &amp;&amp; \
update-alternatives --set python /usr/bin/python3.6 &amp;&amp; \
update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.5 1 &amp;&amp; \
update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.6 2 &amp;&amp; \
update-alternatives --set python3 /usr/bin/python3.6 &amp;&amp; \
</code></pre>
<h4 id="install-packages-with-pip-ignoring-errors">Install packages with pip ignoring errors</h4>
<p>An installation with <code>pip</code> will fail if a dependency is not available, even if that dependency should not be required.
The following command-line install each dependency separately, therefore continuing, even if errors are encountered (<a href="https://stackoverflow.com/a/54053100">source</a>):</p>
<pre><code>cat requirements.txt | sed -e '/^\s*#.*$/d' -e '/^\s*$/d' | xargs -n 1 pip install
</code></pre>
<h3 id="screen">Screen</h3>
<p>The <a href="https://linux.die.net/man/1/screen">screen</a> command-line utility allows you to 
pick up remote sessions after detaching from them. This is especially helpful when 
running docker in interactive mode via ssh sessions. If such an ssh session should
accidentally close (e.g., internet connection lost, laptop closed), then the
docker command would terminate as well.</p>
<p>On the remote host, <strong>start</strong> the <code>screen</code> command before you launch your docker command 
(you can run multiple <code>screen</code> instances as well) and skip the screen with the licenses 
etc using <code>Enter</code> or <code>Space</code>. Now you can start up the actual command. If you want to 
run multiple screen sessions on the same host, then you should name them using the 
<code>-S sessionname</code> option to easily distinguish them. </p>
<p>When running multiple sessions on a single host that use the auto-generated names, 
it can get difficult to distinguish them. You can use 
<code>screen -S &lt;PID&gt;.&lt;sessionName&gt; -X sessionname &lt;newSessionName&gt;</code> to rename an 
existing session to use a more suitable name (<a href="https://www.shellhacks.com/screen-rename-session/">source</a>).</p>
<p>For <strong>detaching</strong> a session, use the <code>CTRL+A+D</code> key combination. This will leave your 
process running in the background and you can close the remote connection.</p>
<p>In order to <strong>reconnect</strong>, simply ssh into the remote host and run <code>screen -r</code>. If there
is only one screen session running, then it will automatically reconnect. Otherwise, it
will output a list of available sessions. Supply the name of the session that you want to 
reattach to the <code>-r</code> option. In case a session got interrupted and not properly detached,
use the <code>-d</code> flag to first detach it.</p>
<p>You can <strong>exit</strong> a screen session by either typing <code>exit</code> or using <code>CTRL+D</code> (just like
with a <code>bash</code> shell).</p>
<p>If you need to increase the scrollback buffer, let us say to 100,000 lines, then you can do it</p>
<ul>
<li>
<p>in the current session as follows:</p>
<p><code>CTRL A : &lt;Enter&gt;
scrollback 100000&lt;Enter&gt;</code></p>
</li>
<li>
<p>for all new sessions by adding the following line in your <code>$HOME/.screenrc</code> config file:</p>
<p><code>defscrollback 100000</code></p>
</li>
</ul>
<h3 id="default-runtime">Default runtime</h3>
<p>Instead of always having to type <code>--runtime=nvidia</code> or <code>--gpus=all</code>, you can simply define
the <em>default runtime</em> to use with your docker commands (<a href="https://docs.nvidia.com/dgx/nvidia-container-runtime-upgrade/index.html">source</a>):</p>
<ul>
<li>edit the <code>/etc/docker/daemon.json</code> file as <code>root</code> user</li>
<li>insert the key <code>default-runtime</code> with value <code>nvidia</code> so that it looks something like this:</li>
</ul>
<pre><code class="language-json">{
    &quot;default-runtime&quot;: &quot;nvidia&quot;,
    &quot;runtimes&quot;: {
        &quot;nvidia&quot;: {
            &quot;path&quot;: &quot;nvidia-container-runtime&quot;,
            &quot;runtimeArgs&quot;: []
        }
    }
}
</code></pre>
<ul>
<li>save the file</li>
<li>restart the docker daemon (e.g., <code>sudo systemctl restart docker</code>)</li>
</ul>
<h3 id="rebuild">Rebuild</h3>
<h4 id="rebuilding-some-layers">Rebuilding some layers</h4>
<p>Since docker hashes the layer instructions rather than the content, it will not detect changes to a file 
(e.g., modifications in a script) since the last build and will keep using the cached version of that layer.</p>
<p>Assuming the following <code>Dockerfile</code> snippet, where <code>file1</code> changed:</p>
<pre><code>RUN ...&lt;layer X&gt;...
COPY file1 ...&lt;layer X+1&gt;...
COPY file2 ...&lt;layer X+2&gt;...
</code></pre>
<p>You can <strong>inject</strong> a dummy <strong>ARG</strong> variable as follows to rebuild the layers from <code>layer X+1</code> onwards:</p>
<pre><code>RUN ...&lt;layer X&gt;...
ARG blah=1
COPY file1 ...&lt;layer X+1&gt;...
COPY file2 ...&lt;layer X+2&gt;...
</code></pre>
<p>Every time you need rebuild from there on, simply change the value that you are assigning to the variable, 
to change the hash value.</p>
<p>Of course, once your <code>Dockerfile</code> has been finalized, you can remove all these unnecessary operations and
build your image properly.</p>
<h4 id="complete-rebuild">Complete rebuild</h4>
<p>Especially during development of a docker image, it can happen that library versions have not been added to the <code>Dockerfile</code> just yet. Since docker hashes the command-lines, it will not rebuild a layer (and subsequent ones) if the hash does not change. If you do not want to clear your complete system (due to time constraints or capped internet usage), then you can force docker to build the image without using the hashed layers by adding the following flag to your <a href="https://docs.docker.com/engine/reference/commandline/build/">build</a> command:</p>
<pre><code>--no-cache
</code></pre>
<h3 id="thorough-clean-up">Thorough clean up</h3>
<p>You can stop/remove all containers and images with this one-liner:</p>
<pre><code class="language-bash">docker stop $(docker ps -a -q) &amp;&amp; docker rm $(docker ps -a -q) &amp;&amp; docker system prune -a
</code></pre>
<p>If you need to remove dangling volumes, use this:</p>
<pre><code class="language-commandline">docker volume prune
</code></pre>
<h3 id="excluding-filesdirs-from-docker-context">Excluding files/dirs from docker context</h3>
<p>By default, docker will use all files and directories within the directory that contains the <code>Dockerfile</code> to
the daemon to use as <em>context</em>. From this context, the image gets built. Should you have test data/models
in the same directory then this could mean sending quite a lot of unnecessary data to the daemon. To avoid this,
you can take advantage of the <code>.dockerignore</code> file, which lists files and directories to ignore. The following
example ignores the <code>test</code> directory and all vim backup files:</p>
<pre><code>test/
*~
</code></pre>
<p>For more information, see the official documentation on the <a href="https://docs.docker.com/engine/reference/builder/#dockerignore-file">dockerignore file</a>.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../best_practices/" class="btn btn-neutral float-left" title="Best practices"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../troubleshooting/" class="btn btn-neutral float-right" title="Troubleshooting">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../best_practices/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../troubleshooting/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
