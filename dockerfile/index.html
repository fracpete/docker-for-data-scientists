
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="From one data scientist to another on how to utilize docker to make your life easier">
      
      
      
        <link rel="canonical" href="https://www.data-mining.co.nz/docker-for-data-scientists/dockerfile/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>Dockerfile - Docker for Data Scientists</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.472b142f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.08040f6c.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="None" data-md-color-accent="None">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#comments" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Docker for Data Scientists" class="md-header__button md-logo" aria-label="Docker for Data Scientists" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Docker for Data Scientists
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Dockerfile
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/waikato-datamining/docker-for-data-scientists" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Docker for Data Scientists" class="md-nav__button md-logo" aria-label="Docker for Data Scientists" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Docker for Data Scientists
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/waikato-datamining/docker-for-data-scientists" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../basics/" class="md-nav__link">
        Basics
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../repos/" class="md-nav__link">
        Repositories
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Dockerfile
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Dockerfile
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#comments" class="md-nav__link">
    Comments
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#from" class="md-nav__link">
    FROM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arg" class="md-nav__link">
    ARG
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#env" class="md-nav__link">
    ENV
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run" class="md-nav__link">
    RUN
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#copy" class="md-nav__link">
    COPY
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workdir" class="md-nav__link">
    WORKDIR
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#other-useful-commands" class="md-nav__link">
    Other useful commands
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-the-image" class="md-nav__link">
    Building the image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-the-image-interactive" class="md-nav__link">
    Running the image (interactive)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-the-image-non-interactive" class="md-nav__link">
    Running the image (non-interactive)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimizing-an-image" class="md-nav__link">
    Optimizing an image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pushing-the-image" class="md-nav__link">
    Pushing the image
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../best_practices/" class="md-nav__link">
        Best practices
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tips_and_tricks/" class="md-nav__link">
        Tips & Tricks
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../troubleshooting/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../automation/" class="md-nav__link">
        Automation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../registry/" class="md-nav__link">
        Registry
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#comments" class="md-nav__link">
    Comments
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#from" class="md-nav__link">
    FROM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arg" class="md-nav__link">
    ARG
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#env" class="md-nav__link">
    ENV
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run" class="md-nav__link">
    RUN
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#copy" class="md-nav__link">
    COPY
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workdir" class="md-nav__link">
    WORKDIR
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#other-useful-commands" class="md-nav__link">
    Other useful commands
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-the-image" class="md-nav__link">
    Building the image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-the-image-interactive" class="md-nav__link">
    Running the image (interactive)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-the-image-non-interactive" class="md-nav__link">
    Running the image (non-interactive)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimizing-an-image" class="md-nav__link">
    Optimizing an image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pushing-the-image" class="md-nav__link">
    Pushing the image
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/waikato-datamining/docker-for-data-scientists/edit/main/docs/dockerfile.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


  <h1>Dockerfile</h1>

<p>Using existing docker images unfortunately only gets you so far. Especially, when you 
need to put models into production, it is very likely that you will need to encapsulate
more logic within the image itself to integrate it in your existing processes.</p>
<p>In this section, you will learn the basic building blocks for generating docker images.
By convention the instructions for a docker image are stored in a text file called 
<code>Dockerfile</code> (<a href="https://docs.docker.com/engine/reference/builder/#from">full reference</a>).
This is not set in stone, so you can name it anything you like. However, it is usually best
to stick with the conventions that a community expects (just like with 
<a href="https://www.python.org/dev/peps/pep-0008/">PEP-8</a> in the Python community). </p>
<p>In order to make this section not just a <em>hello world</em> example, we will build an image
that we can use for training and evaluating a PyTorch model on the 
<a href="https://www.cs.toronto.edu/~kriz/cifar.html">CIFAR10 challenge</a>.
The Python script will also output a Matplotlib bar chart, displaying the accuracies of 
the classes.</p>
<p>Each of the following sections will introduce a docker command that will make up the 
final <a href="../files/pytorch-cifar10/Dockerfile.txt">docker script</a> for creating the image. 
Of course, we will also build and use the image, as well as push it out to make it 
publicly available.</p>
<h2 id="comments">Comments<a class="headerlink" href="#comments" title="Permanent link">#</a></h2>
<p>Before we dive into the actual docker commands, a quick note on comments. Just like with
any other programming language, it pays to comment your instructions. Especially, if you
need to work around quirks with some strange command-lines. Comments in docker files, 
like with bash programming, are line comments and start with <code>#</code>.</p>
<h2 id="from">FROM<a class="headerlink" href="#from" title="Permanent link">#</a></h2>
<p>Docker images (just like ogres) are like onions, consisting of multiple layers. This makes
it easy to add more functionality to existing images: reusing is better than recreating.
This approach also preserves a lot of space.</p>
<p>The first (non-comment) statement in your Dockerfile needs to be the <a href="https://docs.docker.com/engine/reference/builder/#from">FROM</a> 
statement, which tells docker the particular base image on top of which you want to build.</p>
<p>Reusing the image from our <code>pull</code> command in the <a href="../basics/">Basics</a> section, we get the
following initial statement:</p>
<pre><code class="language-commandline">FROM pytorch/pytorch:1.6.0-cuda10.1-cudnn7-devel
</code></pre>
<h2 id="arg">ARG<a class="headerlink" href="#arg" title="Permanent link">#</a></h2>
<p>In some cases, your <code>Dockerfile</code> script might need to be parametrized for the build from 
the outside. For defining such a build parameter (with a default value), you can use the 
<a href="https://docs.docker.com/engine/reference/builder/#arg">ARG</a> instruction. Using the 
<code>--build-arg</code> command-line you can override the default value. </p>
<p>The <code>ARG</code> syntax is simple:</p>
<pre><code>ARG key=value
</code></pre>
<p>You can also use <code>ARG</code> to make your <code>FROM</code> statement easier to read, but be aware of the 
<a href="https://docs.docker.com/engine/reference/builder/#understand-how-arg-and-from-interact">interaction between FROM and ARG</a>.</p>
<p>Using <code>ARG</code>, we can pull out the version numbers from our original <code>FROM</code> statement and 
put them in variables. Variables can be used in other statements via <code>${...}</code>.</p>
<p>Here is the <em>human-readable</em> <code>FROM</code> statement:</p>
<pre><code>ARG PYTORCH=&quot;1.6.0&quot;
ARG CUDA=&quot;10.1&quot;
ARG CUDNN=&quot;7&quot;
FROM pytorch/pytorch:${PYTORCH}-cuda${CUDA}-cudnn${CUDNN}-devel
</code></pre>
<h2 id="env">ENV<a class="headerlink" href="#env" title="Permanent link">#</a></h2>
<p>In contrast to <code>ARG</code>, the <a href="https://docs.docker.com/engine/reference/builder/#env">ENV</a> 
instruction is persistent within the docker image and can be used to set environment 
variables rather than build variables. If the variable should not be persistent in 
the final image, as it might interfere with subsequent layers, then you should 
consider using <code>ARG</code> instead.</p>
<p>One such environment variable is <code>DEBIAN_FRONTEND</code>, which changes the behavior of
<code>apt-get</code> (Debian tool to install packages):</p>
<pre><code>ENV DEBIAN_FRONTEND=noninteractive
</code></pre>
<p>The docker documentation on the <a href="https://docs.docker.com/engine/reference/builder/#env">ENV</a>
command lists alternative ways of specifying such an environment variable, for limiting
the scope.</p>
<p>In the <a href="../troubleshooting/#interactive-timezone-prompt">Interactive timezone prompt section</a>
section, you read why you might want to use this variable.</p>
<h2 id="run">RUN<a class="headerlink" href="#run" title="Permanent link">#</a></h2>
<p>Once you have set the stage with base image and variables, you can set about installing
the required software packages. For Debian/Ubuntu based systems, this usually involves
invoking the <code>apt-get</code> package manager and for Python <code>pip/pip3</code>. Executing commands
is achieved with the <a href="https://docs.docker.com/engine/reference/builder/#run">RUN</a> command.</p>
<p>For installing matplotlib, which is not part of our base image, we can use:</p>
<pre><code>RUN pip --no-cache install matplotlib
</code></pre>
<p>You will notice the <code>--no-cache</code> flag, which is not something you would normally use.
In order to avoid downloading the same library over and over again, pip caches them 
by default. This is not necessary for a docker image and just takes up more space. 
But before you argue that you could just remove unwanted files at the end of your 
docker image then you do not take into account that docker works in layers: 
every command is basically a layer. Though a subsequent layer may remove files (and 
you will not see them in the final image), they are still present in the layer that 
they got introduced in.</p>
<p>Long story short: either always clean up within the same layer or 
avoid generating temporary files altogether.</p>
<p>Check out the following <a href="../best_practices/">Best practices</a> sections:</p>
<ul>
<li><a href="../best_practices/#clean-up-pip">Clean up pip</a></li>
<li><a href="../best_practices/#clean-up-apt">Clean up apt</a></li>
</ul>
<h2 id="copy">COPY<a class="headerlink" href="#copy" title="Permanent link">#</a></h2>
<p>Quite often, you will end up just needing little scripts within a docker image
to do the work for you (since all the libraries get installed via <code>apt-get</code> or <code>pip</code>).
For copying files or directories, you can use the <a href="https://docs.docker.com/engine/reference/builder/#copy">COPY</a> 
command. </p>
<p>One thing that we have not talked about yet is the <strong>docker context</strong>. This context 
includes all the files and directories that are on the same level as the <code>Dockerfile</code>. 
The <code>COPY</code> command can only use files and directories that are within this context, 
but not outside (e.g., going up in the directory structure).</p>
<p>You also need to be aware that the complete docker context will get sent to the 
docker daemon during the build process. So best not to have any unnecessary files
and directories in the same directory. However, if it cannot be avoided for certain
files/directories to be present you can use the <a href="https://docs.docker.com/engine/reference/builder/#dockerignore-file">.dockerignore file</a>
to exclude them.</p>
<p>As mentioned at the start, we want to train a PyTorch model and evaluate it. 
Download the <a href="../files/pytorch-cifar10/test.py">test.py</a> script and place it next to 
the <code>Dockerfile</code> that you are currently working on.</p>
<p>In order to include this Python script, use the following command:</p>
<pre><code>COPY test.py /opt/test/test.py
</code></pre>
<p>The <code>COPY</code> command will automatically create directories if they are not present,
which is <code>/opt/test</code> in our case. Any existing file will get overwritten as well.</p>
<p>Not only Python scripts can be copied, you can also create executable bash scripts
that call your actual Python scripts and place them in <code>/usr/bin</code>. For our <code>test.py</code>
the bash script would look like this:</p>
<pre><code>#!/bin/bash

python /opt/test/test.py
</code></pre>
<p>If your script supports command-line options, you can pass them through using <code>"$@"</code>:</p>
<pre><code>#!/bin/bash

python /opt/test/test.py &quot;$@&quot;
</code></pre>
<h2 id="workdir">WORKDIR<a class="headerlink" href="#workdir" title="Permanent link">#</a></h2>
<p>With the <a href="https://docs.docker.com/engine/reference/builder/#workdir">WOKRDIR</a> command,
you can change the current working directory within your docker script. If the directory
does not exist yet, it will get created automatically. This eliminates the need
to use <code>mkdir</code> commands. In our case, we can just use the command to make the
docker container automatically start the prompt in the directory of our Python script
(<code>/opt/test</code>) when used in interactive mode:</p>
<pre><code>WORKDIR /opt/test
</code></pre>
<h2 id="other-useful-commands">Other useful commands<a class="headerlink" href="#other-useful-commands" title="Permanent link">#</a></h2>
<ul>
<li><a href="https://docs.docker.com/engine/reference/builder/#add">ADD</a></li>
<li><a href="https://docs.docker.com/engine/reference/builder/#entrypoint">ENTRYPOINT</a></li>
</ul>
<h2 id="building-the-image">Building the image<a class="headerlink" href="#building-the-image" title="Permanent link">#</a></h2>
<p>With our <a href="../files/pytorch-cifar10/Dockerfile.txt">Dockerfile</a> now finally complete, we
are ready to kick off a build. After changing into the directory containing
the <code>Dockerfile</code>, you can use the <code>build</code> sub-command to perform the build.
Rather than using a hash, we can give it a name via the <code>-t</code> option (<em>tagging</em> it):</p>
<pre><code class="language-commandline">docker build -t pytorchtest .
</code></pre>
<p>You should see similar output like the one below:</p>
<pre><code>Sending build context to Docker daemon  260.6kB
Step 1/8 : ARG PYTORCH=&quot;1.6.0&quot;
Step 2/8 : ARG CUDA=&quot;10.1&quot;
Step 3/8 : ARG CUDNN=&quot;7&quot;
Step 4/8 : FROM pytorch/pytorch:${PYTORCH}-cuda${CUDA}-cudnn${CUDNN}-devel
 ---&gt; bb833e4d631f
Step 5/8 : ENV DEBIAN_FRONTEND noninteractive
 ---&gt; Running in 71812ab36f5a
Removing intermediate container 71812ab36f5a
 ---&gt; 77a27d586581
Step 6/8 : RUN pip --no-cache install matplotlib
 ---&gt; Running in 10d85cc41a73
Collecting matplotlib
  Downloading matplotlib-3.4.2-cp37-cp37m-manylinux1_x86_64.whl (10.3 MB)
Collecting kiwisolver&gt;=1.0.1
  Downloading kiwisolver-1.3.1-cp37-cp37m-manylinux1_x86_64.whl (1.1 MB)
Collecting cycler&gt;=0.10
  Downloading cycler-0.10.0-py2.py3-none-any.whl (6.5 kB)
Requirement already satisfied: pillow&gt;=6.2.0 in /opt/conda/lib/python3.7/site-packages (from matplotlib) (7.2.0)
Requirement already satisfied: numpy&gt;=1.16 in /opt/conda/lib/python3.7/site-packages (from matplotlib) (1.18.5)
Collecting python-dateutil&gt;=2.7
  Downloading python_dateutil-2.8.1-py2.py3-none-any.whl (227 kB)
Collecting pyparsing&gt;=2.2.1
  Downloading pyparsing-2.4.7-py2.py3-none-any.whl (67 kB)
Requirement already satisfied: six in /opt/conda/lib/python3.7/site-packages (from cycler&gt;=0.10-&gt;matplotlib) (1.14.0)
Installing collected packages: kiwisolver, cycler, python-dateutil, pyparsing, matplotlib
Successfully installed cycler-0.10.0 kiwisolver-1.3.1 matplotlib-3.4.2 pyparsing-2.4.7 python-dateutil-2.8.1
Removing intermediate container 10d85cc41a73
 ---&gt; 0361d66c3c44
Step 7/8 : WORKDIR /opt/test
 ---&gt; Running in 14568b3fead5
Removing intermediate container 14568b3fead5
 ---&gt; 7c1a8b7229d0
Step 8/8 : COPY test.py /opt/test/test.py
 ---&gt; ed55c4fb8e62
Successfully built ed55c4fb8e62
Successfully tagged pytorchtest:latest
</code></pre>
<h2 id="running-the-image-interactive">Running the image (interactive)<a class="headerlink" href="#running-the-image-interactive" title="Permanent link">#</a></h2>
<p>With the image successfully built, you can now use it. For this you need to employ the
<a href="https://docs.docker.com/engine/reference/builder/#run">RUN</a> command.</p>
<pre><code class="language-commandline">docker run --gpus=all -v `pwd`:/opt/local -it pytorchtest
</code></pre>
<p>Once the prompt appears, you can execute the <code>test.py</code> script:</p>
<pre><code>root@5e2245aa020a:/opt/test# python test.py 
</code></pre>
<p>While the script is executing, you should see output like this:</p>
<pre><code>cuda:0
Downloading https://www.cs.toronto.edu/~kriz/cifar-10-python.tar.gz to ./data/cifar-10-python.tar.gz
100%|██████████████████████████████████████████████████████████████▉| 170369024/170498071 [00:13&lt;00:00, 13670749.69it/s]Extracting ./data/cifar-10-python.tar.gz to ./data
Files already downloaded and verified
[1,  2000] loss: 2.173
[1,  4000] loss: 1.815
[1,  6000] loss: 1.659
170500096it [00:30, 13670749.69it/s]                                                                                    [1,  8000] loss: 1.557
[1, 10000] loss: 1.499
[1, 12000] loss: 1.449
[2,  2000] loss: 1.377
[2,  4000] loss: 1.356
[2,  6000] loss: 1.329
[2,  8000] loss: 1.315
[2, 10000] loss: 1.293
[2, 12000] loss: 1.264
Finished Training
GroundTruth:    cat  ship  ship plane
Predicted:    cat  ship   car plane
Accuracy of the network on the 10000 test images: 55 %
Accuracy of plane : 60 %
Accuracy of   car : 65 %
Accuracy of  bird : 29 %
Accuracy of   cat : 44 %
Accuracy of  deer : 54 %
Accuracy of   dog : 41 %
Accuracy of  frog : 52 %
Accuracy of horse : 68 %
Accuracy of  ship : 78 %
Accuracy of truck : 63 %
170500096it [01:16, 2240182.93it/s] 
</code></pre>
<p>At the end, the script will generate a bar chart plot and save it as <code>/opt/local/figure.png</code>:</p>
<p><img alt="Generated figure" src="../files/pytorch-cifar10/figure.png" /></p>
<p>If you look at the permissions of the generated image, you will notice that the owner 
is <code>root</code>. Depending on your permissions on the host system, you might not be able to 
remove it from outside the container. One approach is to change the owner using <code>chown</code> 
(from within the container), but that can become tedious. Instead, see the following 
<a href="../best_practices/">Best practices</a> section on how to best address this:</p>
<ul>
<li><a href="../best_practices/#launch-container-as-regular-user">Launch container as regular user</a></li>
</ul>
<p><strong>Congratulations, you have assembled, built and run your first docker image!</strong> </p>
<h2 id="running-the-image-non-interactive">Running the image (non-interactive)<a class="headerlink" href="#running-the-image-non-interactive" title="Permanent link">#</a></h2>
<p>Of course, you do not have to run the image interactively at all. After the initial
development of your docker image and code, you can then use it in your production system.</p>
<p>For running it in non-interactive mode, simply remove the <code>-it</code> flags and
append the command that you want to run. In our case, this is:</p>
<pre><code class="language-commandline">python3 /opt/test/test.py
</code></pre>
<p>The full command-line therefore looks like:</p>
<pre><code class="language-commandline">docker run --gpus=all -v `pwd`:/opt/local pytorchtest python3 /opt/test/test.py
</code></pre>
<h2 id="optimizing-an-image">Optimizing an image<a class="headerlink" href="#optimizing-an-image" title="Permanent link">#</a></h2>
<p>As a final note, you should consider revisiting your <code>Dockerfile</code> once you have
verified that everything is working and optimize it. Optimizing entails: </p>
<ul>
<li>Combine <code>apt-get</code> commands in a single <code>RUN</code> and remove caches at the end</li>
<li>Combine <code>pip</code> commands in a single <code>RUN</code> run and make sure that the pip cache is removed</li>
</ul>
<h2 id="pushing-the-image">Pushing the image<a class="headerlink" href="#pushing-the-image" title="Permanent link">#</a></h2>
<p>Once you are happy with your image and you want to use it on another machine, you will
need to <strong>push</strong> it out to a registry. Otherwise, you will not be able to use the image
on another machine without having to re-build it (therefore defeating the purpose of reusable
images).</p>
<p>For pushing an image, there are typically two sub-commands that come into play:</p>
<ul>
<li><a href="https://docs.docker.com/engine/reference/commandline/tag/">tag</a></li>
<li><a href="https://docs.docker.com/engine/reference/commandline/push/">push</a></li>
</ul>
<p>When building images locally, as we did above, the name is fairly irrelevant (<code>pytorchtest</code>). 
However, when pushing an image to a registry (docker hub or <a href="../registry/">your own</a>), then
naming (aka <em>tagging</em>) an image requires a bit more thought. Assuming that you have
a user account on docker hub called <code>user1234</code>, then you could name your image like this:</p>
<pre><code>user1234/pytorchtest:pytorch1.6.0-cuda10.1-cudnn7-devel-0.0.1
</code></pre>
<p>That way, you still keep using your local image name <code>pytorchtest</code>, but you also
include the version of PyTorch, CUDA and cuDNN. The <code>0.0.1</code> at the end, is the actual
version of your image.</p>
<p>In order to push the image <code>pytorchtest</code> out to docker hub, you first need to give it
the proper tag:</p>
<pre><code class="language-commandline">docker tag \
    pytorchtest \
    user1234/pytorchtest:pytorch1.6.0-cuda10.1-cudnn7-devel-0.0.1
</code></pre>
<p>And for pushing it out, use this command:</p>
<pre><code>docker push user1234/pytorchtest:pytorch1.6.0-cuda10.1-cudnn7-devel-0.0.1
</code></pre>
<p>Once the push is complete, you will find this image at the following URL:</p>
<pre><code>https://hub.docker.com/u/user1234
</code></pre>
<p>Depending on the number of images you have, you may have to search for the
<code>pytorchtest:pytorch1.6.0-cuda10.1-cudnn7-devel-0.0.1</code> tag.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../repos/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Repositories" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Repositories
            </div>
          </div>
        </a>
      
      
        
        <a href="../best_practices/" class="md-footer__link md-footer__link--next" aria-label="Next: Best practices" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Best practices
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.d6c3db9e.min.js"></script>
      
    
  </body>
</html>