<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://www.data-mining.co.nz/docker-for-data-scientists/best_practices/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Best practices - Docker for Data Scientists</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Best practices";
        var mkdocs_page_input_path = "best_practices.md";
        var mkdocs_page_url = "/docker-for-data-scientists/best_practices/";
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Docker for Data Scientists
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../basics/">Basics</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../repos/">Repositories</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../dockerfile/">Dockerfile</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Best practices</a>
    <ul class="current">
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../tips_and_tricks/">Tips & Tricks</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../automation/">Automation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../registry/">Registry</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Docker for Data Scientists</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Best practices</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/waikato-datamining/docker-for-data-scientists/edit/main/docs/best_practices.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="versioning">Versioning<a class="headerlink" href="#versioning" title="Permanent link">#</a></h2>
<p>Since docker determines by the hash of a command whether this particular layer needs
rebuilding, you should, wherever possible, specify the version of the library that
you are installing. That way, whenever you upgrade a library, that layer (and all 
subsequent ones) will get rebuilt. The added bonus is that you will not accidentally 
rebuild the image with a newer version of a library at a later stage that may now be 
incompatible with all the others (<em>Yeah, I'm looking at you, numpy</em>!).</p>
<p>So instead of:</p>
<pre><code class="language-commandline">RUN python3 -m pip install --no-cache-dir numpy &amp;&amp; \
    ... 
</code></pre>
<p>You should do something like this:</p>
<pre><code class="language-commandline">RUN python3 -m pip install --no-cache-dir numpy==1.17.4 &amp;&amp; \
    ... 
</code></pre>
<p>Of course, when you are cloning directly from a github repository, because you require
a specific bugfix or the library does not offer any releases (or only very infrequent),
then you should use a specific commit hash in your command:  </p>
<pre><code class="language-commandline">RUN git clone https://github.com/ACCOUNT/REPO.git &amp;&amp; \
    cd REPO &amp;&amp; \
    git reset --hard 11223344556677889900AABBCCDDEEFF11223344 &amp;&amp; \
    ...
</code></pre>
<h2 id="docker-group">Docker group<a class="headerlink" href="#docker-group" title="Permanent link">#</a></h2>
<p>Instead of running the <code>docker</code> command via <code>sudo</code>, you should consider adding your user
to the <code>docker</code> group instead (in <code>/etc/group</code>). That way, you can run the <code>docker</code> 
command as a regular user.</p>
<h2 id="launch-container-as-regular-user">Launch container as regular user<a class="headerlink" href="#launch-container-as-regular-user" title="Permanent link">#</a></h2>
<p>Once development of your docker image has finished, you should avoid running docker 
containers as the <code>root</code> user and instead run it as the current user (which also 
avoids creating output files in volumes that can only be removed by <code>root</code>).</p>
<p>Use the <code>-u</code> and <code>-e</code> command to specify the user/group IDs and the user name 
as follows:</p>
<pre><code>docker run -u $(id -u):$(id -g) -e USER=$USER ...
</code></pre>
<p>However, the environment variables for you command prompt (when you are using your
container in interactive mode) may not be able to handle this properly. In such a
case you will get output similar to this: </p>
<pre><code>groups: cannot find name for group ID XYZ
I have no name!@c7355d9a1b59:/$ 
</code></pre>
<p>You can rectify this by creating a custom <code>bash.bashrc</code>file using the 
<a href="https://github.com/waikato-datamining/docker-banner-gen">docker-banner-gen</a> library
(which not only outputs a nice banner, but also warns you in case you are running
the container as <code>root</code>).</p>
<p>This custom file can then be added to your docker image using the following command:</p>
<pre><code class="language-commandline">COPY bash.bashrc /etc/bash.bashrc
</code></pre>
<h2 id="no-anaconda">No Anaconda<a class="headerlink" href="#no-anaconda" title="Permanent link">#</a></h2>
<p>Instead of using <a href="https://www.anaconda.com/products/individual">Anaconda</a> for installing
Python packages, you can just use plain <code>pip</code> to install packages from the <a href="https://pypi.org/">Python Package Index</a>.
Anaconda in itself is quite a large installation and will increase the overall docker
image size unnecessarily.</p>
<h2 id="clean-up-pip">Clean up pip<a class="headerlink" href="#clean-up-pip" title="Permanent link">#</a></h2>
<p>Remove the pip cache to reduce the size of your layer after you have installed all your packages:</p>
<pre><code>rm -Rf /root/.cache/pip
</code></pre>
<p>Alternatively, do not cache downloads when installing a package:</p>
<pre><code>pip install --no-cache-dir ...
</code></pre>
<h2 id="clean-up-apt">Clean up apt<a class="headerlink" href="#clean-up-apt" title="Permanent link">#</a></h2>
<p>After performing installs via <code>apt</code> or <code>apt-get</code>, clean up the cache to reduce the 
size of your layer:</p>
<pre><code>apt-get clean &amp;&amp; \
rm -rf /var/lib/apt/lists/*
</code></pre>
<h2 id="caching-models">Caching models<a class="headerlink" href="#caching-models" title="Permanent link">#</a></h2>
<p>As soon as you stop/remove the container, all modifications will be lost. This also includes
any pretrained networks that any of the deep learning frameworks downloaded into its cache.
In order to avoid the constant downloads, you can map the cache directories for the relevant
framework to a local directory on the host:</p>
<p><strong>PyTorch</strong></p>
<ul>
<li>
<p>when running the container as <code>root</code>:</p>
<p><code>-v /some/where/cache:/root/.torch \</code></p>
</li>
<li>
<p>when running the container as regular user:</p>
<p><code>-v /some/where/cache:/.torch \</code></p>
</li>
</ul>
<p><strong>Keras</strong></p>
<ul>
<li>
<p>Map the cache directory (<code>/root/.keras</code>) when running container as <code>root</code>:</p>
<p><code>-v /some/where/cache:/root/.keras</code></p>
</li>
<li>
<p>Or when running as regular user (<code>/tmp/.keras</code>):</p>
<p><code>-v /some/where/cache:/tmp/.keras</code></p>
</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../dockerfile/" class="btn btn-neutral float-left" title="Dockerfile"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../tips_and_tricks/" class="btn btn-neutral float-right" title="Tips & Tricks">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/waikato-datamining/docker-for-data-scientists" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../dockerfile/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../tips_and_tricks/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
